<!DOCTYPE html>
<html lang="en">
<% include partials/head %>

<body>
    <% include partials/navbar %>


    <div class="container-fluid chatbox">
        <ul id="messages" class="list-group">
            <li class="list-group-item active">
                <% rooms.forEach(room => { %>
                <% if (locals.response.name){ %>
                <% if (room.name === response.name) { %>
                <img src="<%= response.logo %>" id="room-logo"></img>
                <span class="room-name"><%= response.name %></span>
                <span class="created-on" style="display:block; font-style:italic">Created on <%= room.createdOn %></span>
                <% } %>
                <% } %>
                <% }) %>
            </li>
        </ul>
        <form action="">
            <div class="form-group">
                <input id="m" autocomplete="off" class="form-control" placeholder="Type your message here"/>
                <button id="send-button">Send</button>
            </div>
        </form>
    </div>

    <% include partials/alert %>
    <% include partials/footer %>

    
    <script>
        $(function () {
            // Randomize the room colors

            let colors = ['#001f3f', '#0074D9', '#7FDBFF', '#39CCCC', '#3D9970', '#2ECC40', '#01FF70', '#FFDC00', '#FF851B', '#FF4136', '#85144b', '#F012BE', '#B10DC9', '#AAAAAA', '#DDDDDD'];
            let i = Math.round(Math.random() * colors.length);
            let randomColor = colors[i];
            document.documentElement.style.setProperty('--room-color', randomColor);

            // Initialize socket.io
            var socket = io();

            socket.on('connect', function () {
                swal({
                    title : "Information",
                    text : "Welcome to your room. This is a typical chat application with a subtle twist. Whatever you write within quotes \"\" will be GIFFYfied. Try it out yourself!",
                    icon : 'info',
                    button : 'Click here to proceed'
                }).then( data => {
                    swal("Enter your name", {
                        content: "input",
                    })
                        .then((value) => {
                            if (!value){
                                swal('Error', 'You need to provide a name', 'error')
                                .then(data => {
                                    window.location.href = `/`;
                                });
                            }
                            else{
                                swal(`Welcome`, `Nice to see you ${value}`, 'success');
                                socket.emit('addUser', value, "<%= response.name %>");
                            }
                        });    
                });
            });

            socket.on('messageUser', (username, data, gifs) => {
                $('#messages').append(`<li class="list-group-item list-group-item-light"> ${username}: ${data} </li>`);
                if (gifs.length !== 0){
                    gifs.forEach(gif => {
                        $('#messages').append(`<li class="list-group-item list-group-item-light"> <img src="${gif}" class="gif-message"></img></li>`);
                    })
                }
                $("#messages").scrollTop($("#messages")[0].scrollHeight);
            });

            $('form').submit(function (e) {
                e.preventDefault(); // prevents page reloading
                socket.emit('chat message', $('#m').val());
                $('#m').val('');
                return false;
            });

            socket.on('chat message', (username, message, gifs) => {
                $('#messages').append(`<li class="list-group-item list-group-item-light"> ${username}:  ${message} </li>`);
                if (gifs.length !== 0){
                    gifs.forEach(gif => {
                        $('#messages').append(`<li class="list-group-item list-group-item-light"> <img src="${gif}" class="gif-message"></img></li>`);
                    });
                }
                $("#messages").scrollTop($("#messages")[0].scrollHeight);
            });
        });
    </script>
</body>

</html>